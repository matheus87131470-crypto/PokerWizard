"use strict";
// PIX Payment Service
// Generates BR Code (QR code payload) and tracks payment status
Object.defineProperty(exports, "__esModule", { value: true });
exports.generateBrCode = generateBrCode;
exports.createPixPayment = createPixPayment;
exports.confirmPixPayment = confirmPixPayment;
exports.getPaymentStatus = getPaymentStatus;
exports.getAllPayments = getAllPayments;
exports.startAutoConfirmation = startAutoConfirmation;
exports.stopAutoConfirmation = stopAutoConfirmation;
const payments = new Map();
const PIX_KEY = 'ae927522-3cf8-44b1-9e65-1797ca2ce670';
const PIX_NAME = 'Matheus Alves Cordeiro';
const PIX_CITY = 'BRAZIL';
const PIX_AMOUNT = 590; // R$ 5,90 in cents
/**
 * Generate BR Code (PIX payload) for the given amount
 * This is a simplified version; a real implementation would use proper BR Code library
 * For now, we'll return a static payload that can be used to generate QR codes
 */
function generateBrCode(amountInCents = PIX_AMOUNT) {
    // Simplified BR Code generation
    // In production, use a library like 'brcode' or similar
    // Format: 00020126580014br.gov.bcb.pix...
    // This is a placeholder; real implementation should:
    // 1. Use proper BR Code encoding
    // 2. Include merchant info, amount, transaction ID
    const payload = `00020126580014br.gov.bcb.brcode01051.0.0${PIX_KEY}520400005303986540${String(amountInCents / 100).padStart(5, '0')}5802BR5913${PIX_NAME}6009${PIX_CITY}62360532${Date.now()}63041D3D`;
    return payload;
}
/**
 * Create a new payment request (generates QR Code)
 */
async function createPixPayment(userId, amountInCents = PIX_AMOUNT) {
    const id = `pix-${Date.now()}`;
    const brCode = generateBrCode(amountInCents);
    const payment = {
        id,
        userId,
        amount: amountInCents,
        brCode,
        qrCodeUrl: `data:image/svg+xml;base64,...`, // Would be generated by a QR code library
        status: 'pending',
        createdAt: new Date(),
    };
    payments.set(id, payment);
    return {
        id,
        amount: amountInCents / 100, // Convert back to reais
        brCode,
        // QR code generation would be done on frontend with qrcode.js library
        expiresIn: 1800, // 30 minutes
    };
}
/**
 * Confirm payment (manual verification)
 */
async function confirmPixPayment(paymentId) {
    const payment = payments.get(paymentId);
    if (!payment)
        return null;
    if (payment.status === 'completed') {
        throw new Error('Payment already completed');
    }
    payment.status = 'completed';
    payment.confirmedAt = new Date();
    return payment;
}
/**
 * Get payment status
 */
async function getPaymentStatus(paymentId) {
    return payments.get(paymentId) || null;
}
// Export all payments for debugging
function getAllPayments() {
    return Array.from(payments.values());
}
/**
 * Automatically confirm pending payments older than `thresholdMs`.
 * For this prototype, confirming a payment will also activate premium
 * for the associated user by calling `setPremium` from `userService`.
 */
const userService_1 = require("./userService");
let _autoConfirmInterval = null;
function startAutoConfirmation(intervalMs = 15000, thresholdMs = 60000) {
    if (_autoConfirmInterval)
        return;
    _autoConfirmInterval = setInterval(async () => {
        try {
            const now = Date.now();
            for (const p of payments.values()) {
                if (p.status === 'pending') {
                    const age = now - p.createdAt.getTime();
                    if (age >= thresholdMs) {
                        p.status = 'completed';
                        p.confirmedAt = new Date();
                        try {
                            await (0, userService_1.setPremium)(p.userId, 30);
                            // eslint-disable-next-line no-console
                            console.log(`[pixService] Auto-confirmed payment ${p.id} and activated premium for user ${p.userId}`);
                        }
                        catch (err) {
                            // eslint-disable-next-line no-console
                            console.error('[pixService] Failed to set premium for user', p.userId, err);
                        }
                    }
                }
            }
        }
        catch (err) {
            // eslint-disable-next-line no-console
            console.error('[pixService] Auto-confirmation loop error', err);
        }
    }, intervalMs);
}
function stopAutoConfirmation() {
    if (_autoConfirmInterval) {
        clearInterval(_autoConfirmInterval);
        _autoConfirmInterval = null;
    }
}
//# sourceMappingURL=pixService.js.map